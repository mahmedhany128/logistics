<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Logistics Intelligence Elite</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    :root {
        --bg: #0a0c10; --card-bg: #161b22; --border: #30363d;
        --text-main: #c9d1d9; --text-dim: #8b949e; --accent: #58a6ff;
        --s-color: #238636; --p-color: #d29922; --c-color: #da3633;
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text-main); margin: 0; padding: 15px; overflow-x: hidden; }

    /* Header & Stats Header */
    header { padding: 20px 10px; border-bottom: 1px solid var(--border); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { font-size: 1.2rem; font-weight: 800; margin: 0; letter-spacing: -0.5px; color: #fff; }
    #syncStatus { font-size: 0.6rem; font-weight: 700; color: var(--accent); background: rgba(88, 166, 255, 0.1); padding: 4px 10px; border-radius: 6px; }

    /* Action Buttons */
    .action-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .btn { background: var(--card-bg); border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .btn:active { transform: scale(0.95); background: var(--border); }
    .btn-primary { background: var(--accent); border: none; }

    /* Date Controller */
    .date-scroller { background: var(--card-bg); display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 14px; border: 1px solid var(--border); margin-bottom: 25px; }
    .month-display { font-weight: 800; font-size: 0.9rem; color: #fff; }

    /* Metrics Grid (The Interactive Cards) */
    .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
    .metric-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 20px; cursor: pointer; position: relative; transition: 0.3s; }
    .metric-card:hover { border-color: var(--accent); }
    .active-card { border: 2px solid var(--accent); box-shadow: 0 0 15px rgba(88, 166, 255, 0.2); }
    .metric-label { font-size: 0.65rem; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
    .metric-value { font-size: 1.8rem; font-weight: 800; display: block; margin-top: 5px; color: #fff; }
    .metric-trend { font-size: 0.6rem; margin-top: 8px; font-weight: 600; display: block; }

    /* The Professional Table Section */
    .table-container { display: none; background: var(--card-bg); border: 1px solid var(--border); border-radius: 22px; margin-bottom: 30px; overflow: hidden; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .table-head { padding: 15px 20px; background: rgba(255,255,255,0.02); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    .table-head h3 { margin: 0; font-size: 0.85rem; font-weight: 800; color: var(--accent); }
    .table-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 500px; }
    th { text-align: center; padding: 12px; font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; border-bottom: 1px solid var(--border); }
    td { padding: 15px 10px; text-align: center; font-size: 0.8rem; font-weight: 600; border-bottom: 1px solid var(--border); }
    .date-col { color: #fff; font-weight: 700; width: 110px; }
    .perc-tag { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; }

    /* Chart Card */
    .chart-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 24px; margin-bottom: 50px; }
    .chart-viewport { height: 250px; }

    /* Entry Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: var(--card-bg); width: 90%; max-width: 400px; padding: 25px; border-radius: 24px; border: 1px solid var(--border); }
    input { background: #0d1117; border: 1px solid var(--border); color: #fff; width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; }
</style>
</head>
<body>

<header>
    <h1>Analytics Pro</h1>
    <div id="syncStatus">CONNECTED</div>
</header>

<div class="action-row">
    <button class="btn btn-primary" onclick="openAddDataModal()">+ Record</button>
    <button class="btn" onclick="exportExcel()">Export</button>
    <button class="btn" style="color:var(--c-color)" onclick="fullReset()">Wipe</button>
</div>

<div class="date-scroller">
    <button onclick="changeMonth(-1)" style="background:none; border:none; color:var(--accent); font-size:1.2rem; cursor:pointer;">◀</button>
    <div class="month-display" id="currentMonthDisplay">...</div>
    <button onclick="changeMonth(1)" style="background:none; border:none; color:var(--accent); font-size:1.2rem; cursor:pointer;">▶</button>
</div>

<div class="metrics-grid" id="metricsGrid"></div>

<div id="tableSection" class="table-container">
    <div class="table-head">
        <h3 id="tableTitle">CHANNEL LOGS</h3>
        <button onclick="closeDetails()" style="background:none; border:none; color:var(--text-dim); cursor:pointer;">×</button>
    </div>
    <div class="table-scroll">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th style="color:var(--s-color)">S</th>
                    <th style="color:var(--p-color)">P</th>
                    <th style="color:var(--c-color)">C</th>
                    <th>Total</th>
                    <th>Efficiency</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div class="chart-card">
    <div class="chart-viewport"><canvas id="mainChart"></canvas></div>
</div>

<div id="addDataModal" class="modal">
    <div class="modal-content">
        <h2 style="margin:0 0 15px 0; font-size:1rem; color:#fff">New Entry Log</h2>
        <input type="date" id="modalDate">
        <div id="modalInputs"></div>
        <button class="btn btn-primary" style="width:100%; margin-top:15px" id="saveBtn">Confirm & Sync</button>
        <button class="btn" style="width:100%; margin-top:8px; border:none" onclick="closeAddDataModal()">Cancel</button>
    </div>
</div>

<script>
let config = JSON.parse(localStorage.getItem('gh_config')) || null;
const channels = ["Delivery", "PickUp", "SameDay", "Khazenly"];
const channelColors = { Delivery: '#58a6ff', PickUp: '#3fb950', SameDay: '#d29922', Khazenly: '#f85149' };
let storageData = JSON.parse(localStorage.getItem("logisticsData")) || {};
channels.forEach(c => { if(!storageData[c]) storageData[c] = []; });
let currentView = new Date();
let activeChannel = null;

function formatCustomDate(dateStr) {
    const d = new Date(dateStr);
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
}

async function init() {
    if (!config) {
        const token = prompt("Token:"); const user = prompt("User:"); const repo = prompt("Repo:");
        if (token) { config = { token, user, repo }; localStorage.setItem('gh_config', JSON.stringify(config)); location.reload(); }
    } else { await fetchCloud(); }
}

async function fetchCloud() {
    const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/data.json`;
    try {
        const res = await fetch(url, { headers: { 'Authorization': `token ${config.token}` } });
        if (res.ok) {
            const j = await res.json();
            storageData = JSON.parse(decodeURIComponent(escape(atob(j.content))));
            localStorage.setItem("logisticsData", JSON.stringify(storageData));
            document.getElementById('syncStatus').innerText = "CLOUD SECURE";
        }
    } catch (e) { document.getElementById('syncStatus').innerText = "LOCAL MODE"; }
    renderAll();
}

async function pushCloud() {
    document.getElementById('syncStatus').innerText = "UPLOADING...";
    const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/data.json`;
    try {
        const res = await fetch(url, { headers: { 'Authorization': `token ${config.token}` } });
        let sha = (res.ok) ? (await res.json()).sha : "";
        await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${config.token}` },
            body: JSON.stringify({ message: "Update", content: btoa(unescape(encodeURIComponent(JSON.stringify(storageData, null, 2)))), sha: sha })
        });
        document.getElementById('syncStatus').innerText = "CLOUD SECURE";
    } catch (e) { alert("Sync Error"); }
}

function renderAll() {
    const yr = currentView.getFullYear();
    const mt = currentView.getMonth();
    const names = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    document.getElementById("currentMonthDisplay").innerText = `${names[mt]} ${yr}`;
    
    document.getElementById("metricsGrid").innerHTML = channels.map(c => {
        const stats = storageData[c].filter(d => {
            const dt = new Date(d.date); return dt.getFullYear() === yr && dt.getMonth() === mt;
        });
        const totalS = stats.reduce((acc, d) => acc + (d.s || 0), 0);
        const totalAll = stats.reduce((acc, d) => acc + (d.s||0) + (d.p||0) + (d.c||0), 0);
        const rate = totalAll > 0 ? ((totalS/totalAll)*100).toFixed(0) : 0;
        
        return `
            <div class="metric-card ${activeChannel === c ? 'active-card' : ''}" onclick="showTable('${c}')">
                <span class="metric-label" style="color:${channelColors[c]}">${c}</span>
                <span class="metric-value">${totalS.toLocaleString()}</span>
                <span class="metric-trend" style="color:${rate > 80 ? 'var(--s-color)' : 'var(--p-color)'}">${rate}% Monthly Rate</span>
            </div>`;
    }).join('');

    renderChart(yr, mt);
    if(activeChannel) showTable(activeChannel);
}

function showTable(channel) {
    activeChannel = channel;
    const box = document.getElementById("tableSection");
    const body = document.getElementById("tableBody");
    const yr = currentView.getFullYear(); const mt = currentView.getMonth();
    
    box.style.display = "block";
    document.getElementById("tableTitle").innerText = `${channel.toUpperCase()} ANALYTICS`;

    const filtered = storageData[channel].filter(d => {
        const dt = new Date(d.date); return dt.getFullYear() === yr && dt.getMonth() === mt;
    }).sort((a,b) => new Date(b.date) - new Date(a.date));

    body.innerHTML = filtered.map(r => {
        const sum = (r.s||0) + (r.p||0) + (r.c||0);
        const eff = sum > 0 ? ((r.s/sum)*100).toFixed(1) : 0;
        const color = eff > 85 ? 'var(--s-color)' : (eff > 60 ? 'var(--p-color)' : 'var(--c-color)');
        return `
            <tr>
                <td class="date-col">${formatCustomDate(r.date)}</td>
                <td style="color:var(--s-color)">${r.s}</td>
                <td style="color:var(--p-color)">${r.p}</td>
                <td style="color:var(--c-color)">${r.c}</td>
                <td style="background:rgba(255,255,255,0.03)">${sum}</td>
                <td><span class="perc-tag" style="background:${color}20; color:${color}">${eff}%</span></td>
            </tr>`;
    }).join('');
    document.querySelectorAll('.metric-card').forEach((k, i) => k.classList.toggle('active-card', channels[i] === channel));
}

function renderChart(yr, mt) {
    const ctx = document.getElementById('mainChart').getContext('2d');
    const days = new Date(yr, mt + 1, 0).getDate();
    const labels = Array.from({length: days}, (_, i) => i + 1);
    
    const datasets = channels.map(c => ({
        label: c,
        data: labels.map(day => {
            const dStr = `${yr}-${String(mt+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const f = storageData[c].find(d => d.date === dStr);
            return f ? f.s : 0;
        }),
        borderColor: channelColors[c],
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.3,
        fill: false
    }));

    if(window.chart) window.chart.destroy();
    window.chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { 
                x: { grid: { color: '#30363d' }, ticks: { font: { size: 9 } } },
                y: { grid: { color: '#30363d' }, ticks: { font: { size: 9 } } }
            }
        }
    });
}

function openAddDataModal() {
    document.getElementById("addDataModal").style.display = "flex";
    document.getElementById("modalDate").value = new Date().toISOString().split('T')[0];
    document.getElementById("modalInputs").innerHTML = channels.map(c => `
        <div style="margin-bottom:12px">
            <label style="font-size:0.6rem; font-weight:800; color:${channelColors[c]}">${c}</label>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px">
                <input type="number" id="s_${c}" placeholder="S">
                <input type="number" id="p_${c}" placeholder="P">
                <input type="number" id="c_${c}" placeholder="C">
            </div>
        </div>`).join('');

    document.getElementById("saveBtn").onclick = async () => {
        const date = document.getElementById("modalDate").value;
        channels.forEach(c => {
            const entry = { date, s: parseInt(document.getElementById(`s_${c}`).value)||0, p: parseInt(document.getElementById(`p_${c}`).value)||0, c: parseInt(document.getElementById(`c_${c}`).value)||0 };
            const idx = storageData[c].findIndex(d => d.date === date);
            if(idx >= 0) storageData[c][idx] = entry; else storageData[c].push(entry);
        });
        localStorage.setItem("logisticsData", JSON.stringify(storageData));
        closeAddDataModal(); renderAll(); await pushCloud();
    };
}

function closeAddDataModal() { document.getElementById("addDataModal").style.display = "none"; }
function closeDetails() { activeChannel = null; document.getElementById("tableSection").style.display = "none"; renderAll(); }
function changeMonth(s) { currentView.setMonth(currentView.getMonth() + s); renderAll(); }
function fullReset() { if(confirm("Clear everything?")) { if(prompt("Type DELETE:") === "DELETE") { channels.forEach(c => storageData[c] = []); localStorage.setItem("logisticsData", JSON.stringify(storageData)); renderAll(); pushCloud(); } } }

init();
</script>
</body>
</html>
