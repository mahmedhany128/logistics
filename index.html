<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Logistics Pro - Cloud Master</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111827">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

<style>
    :root {
        --primary: #111827; --subtle: #9ca3af; --border: #f3f4f6;
        --deliv: #10b981; --bg: #f9fafb; --blue-btn: #3b82f6;
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); margin: 0; padding: 15px; color: var(--primary); }

    header h1 { font-size: 1.4rem; font-weight: 900; text-align: center; margin-bottom: 20px; }
    
    .status-badge { 
        display: block; text-align: center; font-size: 0.65rem; font-weight: 900; 
        padding: 8px; background: #fff; border-radius: 12px; border: 1px solid var(--border);
        margin-bottom: 15px; color: var(--subtle);
    }

    .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 25px; }
    .btn { padding: 12px; border: 1px solid #e5e7eb; background: #fff; border-radius: 14px; font-size: 0.75rem; font-weight: 800; cursor: pointer; }
    .btn-dark { background: var(--primary); color: #fff; border: none; }

    .date-nav { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #fff; border-radius: 18px; margin-bottom: 20px; border: 1px solid var(--border); }
    .month-label { font-weight: 900; font-size: 1rem; }

    .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .item-card { padding: 15px; border-radius: 20px; background: #fff; border: 1px solid var(--border); border-left: 5px solid #ccc; }
    .delivered-value { font-size: 1.8rem; font-weight: 900; display: block; margin: 4px 0; }
    .item-name { font-size: 0.6rem; font-weight: 900; color: var(--subtle); text-transform: uppercase; }

    .chart-section { margin-top: 25px; background: #fff; padding: 15px; border-radius: 22px; border: 1px solid var(--border); }
    .chart-viewport { width: 100%; overflow-x: auto; }
    .chart-wrapper { min-width: 600px; height: 250px; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: white; width: 92%; max-width: 380px; padding: 25px; border-radius: 25px; }
    input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; }
</style>
</head>
<body>

<header><h1>Operations Hub</h1></header>

<div class="status-badge" id="cloudStatus">ðŸ”„ Syncing with GitHub...</div>

<div class="btn-group">
    <button class="btn" onclick="resetConfig()">Reset Config</button>
    <button class="btn" onclick="exportExcel()">Export XLSX</button>
    <button class="btn btn-dark" onclick="openAddDataModal()">+ New Record</button>
</div>

<div class="date-nav">
    <button class="btn" style="border:none; font-size:1.2rem" onclick="changeMonth(-1)">â€¹</button>
    <div class="month-label" id="currentMonthDisplay">...</div>
    <button class="btn" style="border:none; font-size:1.2rem" onclick="changeMonth(1)">â€º</button>
</div>

<div class="card-grid" id="dashboard"></div>

<div class="chart-section">
    <canvas id="main_chart"></canvas>
</div>

<div id="addDataModal" class="modal">
    <div class="modal-content">
        <h3 style="margin:0 0 15px 0;">Daily Log</h3>
        <input type="date" id="modalDate">
        <div id="modalInputs"></div>
        <button class="btn btn-dark" style="width:100%; margin-top:15px;" id="saveBtn">Sync to GitHub</button>
        <button class="btn" style="width:100%; margin-top:8px; border:none;" onclick="closeAddDataModal()">Cancel</button>
    </div>
</div>

<script>
const types = ["Delivery", "PickUp", "SameDay", "Khazenly"];
const typeColors = { Delivery: '#111827', PickUp: '#10b981', SameDay: '#f59e0b', Khazenly: '#ef4444' };

// --- GitHub Configuration ---
let config = JSON.parse(localStorage.getItem('gh_config')) || null;
let data = {}; // Ø³ØªØ¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
let viewDate = new Date();

async function init() {
    if (!config) {
        const token = prompt("Enter GitHub Token (ghp_...):");
        const user = prompt("Enter GitHub Username:");
        const repo = prompt("Enter Repo Name:");
        if (token && user && repo) {
            config = { token, user, repo };
            localStorage.setItem('gh_config', JSON.stringify(config));
            location.reload();
        }
    } else {
        await fetchFromCloud();
    }
}

async function fetchFromCloud() {
    const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/data.json`;
    try {
        const res = await fetch(url, { headers: { 'Authorization': `token ${config.token}` } });
        if (res.ok) {
            const json = await res.json();
            data = JSON.parse(decodeURIComponent(escape(atob(json.content))));
            document.getElementById('cloudStatus').innerText = "âœ… Cloud Synced";
            renderDashboard();
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ù†Ù†Ø´Ø¦ Ù‡ÙŠÙƒÙ„Ø§Ù‹ ÙØ§Ø±ØºØ§Ù‹
            types.forEach(t => data[t] = []);
            renderDashboard();
        }
    } catch (e) {
        document.getElementById('cloudStatus').innerText = "âŒ Connection Error";
    }
}

async function pushToCloud() {
    document.getElementById('cloudStatus').innerText = "â³ Pushing to GitHub...";
    const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/data.json`;
    
    try {
        // 1. Get SHA
        const res = await fetch(url, { headers: { 'Authorization': `token ${config.token}` } });
        let sha = "";
        if (res.ok) { const json = await res.json(); sha = json.sha; }

        // 2. Upload
        const update = await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: "Update Logistics Data",
                content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                sha: sha
            })
        });

        if (update.ok) {
            document.getElementById('cloudStatus').innerText = "âœ… GitHub Updated Successfully";
            renderDashboard();
        }
    } catch (e) {
        alert("Sync Failed!");
    }
}

// --- Dashboard Logic ---
function renderDashboard() {
    const year = viewDate.getFullYear();
    const month = viewDate.getMonth();
    document.getElementById("currentMonthDisplay").innerText = viewDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
    
    const container = document.getElementById("dashboard");
    container.innerHTML = types.map(t => {
        const sum = (data[t] || [])
            .filter(d => { let dt = new Date(d.date); return dt.getFullYear() === year && dt.getMonth() === month; })
            .reduce((s, d) => s + (d.delivered || 0), 0);
        
        return `
            <div class="item-card" style="border-left-color: ${typeColors[t]}">
                <span class="item-name">${t}</span>
                <span class="delivered-value" style="color:${typeColors[t]}">${sum}</span>
            </div>
        `;
    }).join('');
    renderChart();
}

function renderChart() {
    const ctx = document.getElementById('main_chart').getContext('2d');
    const year = viewDate.getFullYear();
    const month = viewDate.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);

    const datasets = types.map(t => ({
        label: t,
        data: labels.map(day => {
            const dStr = `${year}-${String(month+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const entry = (data[t] || []).find(d => d.date === dStr);
            return entry ? entry.delivered : 0;
        }),
        borderColor: typeColors[t],
        tension: 0.3,
        fill: false
    }));

    if(window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, plugins: { legend: { display: false } } } });
}

function openAddDataModal() {
    document.getElementById("addDataModal").style.display = "flex";
    document.getElementById("modalDate").value = new Date().toISOString().split('T')[0];
    const container = document.getElementById("modalInputs");
    container.innerHTML = types.map(t => `
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px; margin-top:8px; align-items:center;">
            <b style="font-size:0.7rem;">${t}</b>
            <input type="number" id="d_${t}" placeholder="Success Count">
        </div>
    `).join('');

    document.getElementById("saveBtn").onclick = async () => {
        const date = document.getElementById("modalDate").value;
        types.forEach(t => {
            const val = parseInt(document.getElementById(`d_${t}`).value) || 0;
            const entry = { date, delivered: val };
            if(!data[t]) data[t] = [];
            const idx = data[t].findIndex(d => d.date === date);
            if(idx >= 0) data[t][idx] = entry; else data[t].push(entry);
        });
        closeAddDataModal();
        await pushToCloud();
    };
}

function closeAddDataModal() { document.getElementById("addDataModal").style.display = "none"; }
function changeMonth(s) { viewDate.setMonth(viewDate.getMonth() + s); renderDashboard(); }
function resetConfig() { if(confirm("Clear Token?")) { localStorage.clear(); location.reload(); } }
function exportExcel() { 
    const wb = XLSX.utils.book_new();
    types.forEach(t => XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data[t]), t));
    XLSX.writeFile(wb, "Cloud_Logistics.xlsx");
}

init();
</script>
</body>
</html>
