<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Logistics Pro - Full Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #0f172a; --card: #1e293b; --brand: #818cf8; --text: #f1f5f9; 
            --success: #22c55e; --warning: #eab308; --danger: #ef4444; --border: #334155;
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 100px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 20px; border: 1px solid var(--border); position: relative; }
        .stat-val { font-size: 1.5rem; font-weight: 900; display: block; }
        .percent-tag { position: absolute; top: 8px; left: 8px; font-size: 0.75rem; font-weight: bold; }

        .chart-container { background: var(--card); padding: 15px; border-radius: 25px; margin-top: 20px; border: 1px solid var(--border); height: 250px; }

        .input-group { background: var(--card); padding: 20px; border-radius: 25px; margin-top: 20px; border: 1px solid var(--border); }
        .input-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        input, select { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: white; font-size: 0.9rem; }
        .cam-btn { background: var(--brand); border: none; padding: 12px; border-radius: 12px; color: white; cursor: pointer; display: flex; align-items: center; }

        .table-container { background: var(--card); border-radius: 20px; margin-top: 20px; overflow: hidden; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #ffffff05; padding: 12px; color: var(--brand); }
        td { padding: 12px; text-align: center; border-top: 1px solid var(--border); }

        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; align-items: flex-end; }
        .bottom-sheet { background: var(--card); width: 100%; border-radius: 25px 25px 0 0; padding: 20px; max-height: 70vh; overflow-y: auto; border-top: 3px solid var(--brand); }
        .code-item { display: flex; justify-content: space-between; background: var(--bg); padding: 12px; border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--border); }

        .footer-btns { position: fixed; bottom: 15px; left: 15px; right: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { border: none; padding: 15px; border-radius: 18px; font-weight: bold; cursor: pointer; color: white; font-size: 0.9rem; }
        #reader { width: 100%; border-radius: 15px; margin-bottom: 10px; display: none; border: 2px solid var(--brand); }
    </style>
</head>
<body>

<header style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">Logistics Pro ğŸš€</h3>
    <div id="syncStatus" style="font-size:0.7rem; font-weight:bold; color:var(--brand);">Ù…Ø²Ø§Ù…Ù†Ø©...</div>
</header>

<div class="grid" id="metrics"></div>

<div class="chart-container">
    <canvas id="mainChart"></canvas>
</div>

<div class="input-group">
    <div id="reader"></div>
    <div class="input-row">
        <select id="coSelect"><option>Delivery</option><option>PickUp</option><option>SameDay</option><option>Khazenly</option></select>
        <select id="statusSelect"><option value="s">Ù†Ø§Ø¬Ø­ âœ…</option><option value="p">Ù…Ø¹Ù„Ù‚ â³</option><option value="c">Ù…Ø±ØªØ¬Ø¹ âŒ</option></select>
    </div>
    <div class="input-row">
        <input type="text" id="barcodeInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹...">
        <button class="cam-btn" onclick="toggleScanner()">ğŸ“·</button>
    </div>
    <button class="btn" style="background:var(--brand); width:100%;" onclick="addManual()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
</div>

<div id="detailsArea" style="display:none;">
    <div class="table-container">
        <table>
            <thead><tr><th>Ø§Ù„ÙŠÙˆÙ…</th><th>âœ…</th><th>â³</th><th>âŒ</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div class="footer-btns">
    <button class="btn" style="background:var(--card); border:1px solid var(--border);" onclick="exportExcel()">ØªÙ‚Ø±ÙŠØ± Excel ğŸ“Š</button>
    <button class="btn" style="background:var(--danger);" onclick="wipeData()">ØªØµÙÙŠØ± ğŸ—‘ï¸</button>
</div>

<div id="codeSheet" class="overlay" onclick="this.style.display='none'">
    <div class="bottom-sheet" onclick="event.stopPropagation()">
        <h4 id="sheetTitle" style="margin:0 0 15px 0;">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h4>
        <div id="sheetBody"></div>
    </div>
</div>

<script>
let config = JSON.parse(localStorage.getItem('gh_config'));
const types = ["Delivery", "PickUp", "SameDay", "Khazenly"];
let myChart;

function loadData() {
    const keys = ["logistics_final_v1", "logistics_v16_data", "logistics_v15_data", "logistics_v12_data"];
    for (let k of keys) {
        let d = localStorage.getItem(k);
        if(d) return JSON.parse(d);
    }
    return {};
}

let storage = loadData();
types.forEach(t => { if(!storage[t]) storage[t] = []; });

async function init() {
    if(!config) {
        const token = prompt("GitHub Token:"), user = prompt("User:"), repo = prompt("Repo:");
        if(token) { config={token,user,repo}; localStorage.setItem('gh_config', JSON.stringify(config)); location.reload(); }
    } else {
        updateUI();
        await syncCloud();
    }
}

function updateUI() {
    renderCards();
    updateChart();
    if(document.getElementById('detailsArea').style.display === 'block') {
        const activeCo = document.querySelector('.stat-card[style*="border: 2px"]') || {innerText: types[0]};
        showTable(activeCo.innerText.split('\n')[1] || types[0]);
    }
}

function renderCards() {
    document.getElementById('metrics').innerHTML = types.map(t => {
        const m = storage[t] || [];
        const s = m.reduce((a,b) => a + (b.s?.length || 0), 0);
        const total = m.reduce((a,b) => a + (b.s?.length + b.p?.length + b.c?.length || 0), 0);
        const p = total > 0 ? ((s/total)*100).toFixed(1) : 0;
        const color = p >= 90 ? 'var(--success)' : (p >= 70 ? 'var(--warning)' : 'var(--danger)');
        
        return `<div class="stat-card" onclick="showTable('${t}')">
            <span class="percent-tag" style="color:${color}">${p}%</span>
            <small style="color:var(--dim)">${t}</small>
            <span class="stat-val">${s}</span>
        </div>`;
    }).join('');
}

function updateChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    const allS = types.reduce((acc, t) => acc + storage[t].reduce((a,b) => a + b.s.length, 0), 0);
    const allP = types.reduce((acc, t) => acc + storage[t].reduce((a,b) => a + b.p.length, 0), 0);
    const allC = types.reduce((acc, t) => acc + storage[t].reduce((a,b) => a + b.c.length, 0), 0);

    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Ù†Ø§Ø¬Ø­ âœ…', 'Ù…Ø¹Ù„Ù‚ â³', 'Ù…Ø±ØªØ¬Ø¹ âŒ'],
            datasets: [{
                data: [allS, allP, allC],
                backgroundColor: ['#22c55e', '#eab308', '#ef4444'],
                borderRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#f1f5f9' } } }
        }
    });
}

function addManual() {
    const code = document.getElementById('barcodeInput').value;
    const co = document.getElementById('coSelect').value;
    const status = document.getElementById('statusSelect').value;
    const date = new Date().toISOString().split('T')[0];

    if(!code) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹");

    let dayEntry = storage[co].find(x => x.date === date);
    if(!dayEntry) {
        dayEntry = { date, s:[], p:[], c:[] };
        storage[co].push(dayEntry);
    }

    if(!dayEntry[status].includes(code)) {
        dayEntry[status].push(code);
        document.getElementById('barcodeInput').value = "";
        save();
    } else {
        alert("Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…!");
    }
}

function toggleScanner() {
    const r = document.getElementById('reader');
    const scannerObj = new Html5Qrcode("reader");
    if(r.style.display === 'block') {
        r.style.display = 'none';
        Html5Qrcode.terminate();
    } else {
        r.style.display = 'block';
        scannerObj.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
            document.getElementById('barcodeInput').value = txt;
            navigator.vibrate(100);
            r.style.display = 'none';
            scannerObj.stop();
        });
    }
}

function showTable(type) {
    document.getElementById('detailsArea').style.display = 'block';
    const data = storage[type].sort((a,b) => new Date(b.date) - new Date(a.date));
    document.getElementById('tableBody').innerHTML = data.map(r => `
        <tr>
            <td>${r.date.split('-').slice(1).join('/')}</td>
            <td style="color:var(--success)" onclick="openSheet('${type}','${r.date}','s')">${r.s.length}</td>
            <td style="color:var(--warning)" onclick="openSheet('${type}','${r.date}','p')">${r.p.length}</td>
            <td style="color:var(--danger)" onclick="openSheet('${type}','${r.date}','c')">${r.c.length}</td>
            <td style="font-weight:900;">${r.s.length+r.p.length+r.c.length}</td>
        </tr>
    `).join('');
}

function openSheet(type, date, cat) {
    const codes = storage[type].find(x => x.date === date)[cat];
    document.getElementById('sheetBody').innerHTML = codes.length > 0 ? codes.map((c, i) => `
        <div class="code-item">
            <span style="font-weight:bold;">${c}</span>
            <span style="color:var(--danger); font-size:0.8rem;" onclick="deleteCode('${type}','${date}','${cat}',${i})">Ø­Ø°Ù ğŸ—‘ï¸</span>
        </div>
    `).join('') : '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù…Ø³Ø¬Ù„Ø©</p>';
    document.getElementById('codeSheet').style.display = 'flex';
}

function deleteCode(t, d, c, i) {
    storage[t].find(x => x.date === d)[c].splice(i, 1);
    save();
    document.getElementById('codeSheet').style.display = 'none';
}

async function save() {
    localStorage.setItem("logistics_final_v1", JSON.stringify(storage));
    updateUI();
    await syncCloud();
}

async function syncCloud() {
    document.getElementById('syncStatus').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
    const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/data.json`;
    try {
        const r = await fetch(url, { headers: {'Authorization': `token ${config.token}`} });
        let sha = r.ok ? (await r.json()).sha : "";
        await fetch(url, {
            method: 'PUT',
            headers: {'Authorization': `token ${config.token}`},
            body: JSON.stringify({ message:"Auto Sync", content:btoa(unescape(encodeURIComponent(JSON.stringify(storage)))), sha })
        });
        document.getElementById('syncStatus').innerText = "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ âœ…";
    } catch(e) { document.getElementById('syncStatus').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© âš ï¸"; }
}

function exportExcel() {
    let rows = [];
    types.forEach(t => storage[t].forEach(d => {
        d.s.forEach(c => rows.push({Ø§Ù„ØªØ§Ø±ÙŠØ®: d.date, Ø§Ù„Ø´Ø±ÙƒØ©: t, Ø§Ù„ÙƒÙˆØ¯: c, Ø§Ù„Ø­Ø§Ù„Ø©: "Ù†Ø§Ø¬Ø­"}));
        d.p.forEach(c => rows.push({Ø§Ù„ØªØ§Ø±ÙŠØ®: d.date, Ø§Ù„Ø´Ø±ÙƒØ©: t, Ø§Ù„ÙƒÙˆØ¯: c, Ø§Ù„Ø­Ø§Ù„Ø©: "Ù…Ø¹Ù„Ù‚"}));
        d.c.forEach(c => rows.push({Ø§Ù„ØªØ§Ø±ÙŠØ®: d.date, Ø§Ù„Ø´Ø±ÙƒØ©: t, Ø§Ù„ÙƒÙˆØ¯: c, Ø§Ù„Ø­Ø§Ù„Ø©: "Ù…Ø±ØªØ¬Ø¹"}));
    }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„ØªÙ‚Ø±ÙŠØ±");
    XLSX.writeFile(wb, `Report_${new Date().toLocaleDateString()}.xlsx`);
}

function wipeData() { if(confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) { storage={}; types.forEach(t=>storage[t]=[]); save(); } }

init();
</script>
</body>
</html>
