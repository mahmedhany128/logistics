<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Logistics Pro - Master Edition</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
    :root {
        --primary: #111827; --subtle: #9ca3af; --border: #f3f4f6;
        --deliv: #10b981; --pend: #f59e0b; --canc: #ef4444; --bg: #f9fafb;
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); margin: 0; padding: 15px; color: var(--primary); }

    header h1 { font-size: 1.4rem; font-weight: 900; text-align: center; margin-bottom: 20px; letter-spacing: -1px; }
    #syncStatus { text-align: center; font-size: 0.6rem; font-weight: 900; color: var(--subtle); margin-bottom: 10px; text-transform: uppercase; }

    /* Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
    .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .btn { padding: 14px; border: 1px solid #e5e7eb; background: #fff; border-radius: 16px; font-size: 0.75rem; font-weight: 800; cursor: pointer; }
    .btn-dark { background: var(--primary); color: #fff; border: none; }
    .btn-danger { color: var(--canc); background: #fef2f2; border-color: #fee2e2; }

    .date-nav { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #fff; border-radius: 20px; margin-bottom: 20px; border: 1px solid var(--border); }
    .month-label { font-weight: 900; font-size: 1.1rem; }

    /* Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© */
    .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .item-card { padding: 20px; border-radius: 26px; background: #fff; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
    .item-card:active { transform: scale(0.96); }
    .active-card { border: 2.5px solid var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
    .delivered-value { font-size: 2.1rem; font-weight: 900; display: block; letter-spacing: -1px; }

    /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (ÙÙˆÙ‚ Ø§Ù„Ø´Ø§Ø±Øª) */
    .detail-section { display: none; margin-bottom: 25px; background: #fff; border-radius: 24px; border: 1px solid var(--border); overflow: hidden; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    .table-header { padding: 15px 20px; font-weight: 900; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 450px; }
    th { padding: 12px 15px; background: #f9fafb; font-size: 0.6rem; color: var(--subtle); text-transform: uppercase; text-align: center; }
    td { padding: 12px 15px; text-align: center; font-size: 0.75rem; font-weight: 700; border-bottom: 1px solid #f9fafb; }

    /* Ø§Ù„Ø´Ø§Ø±Øª Ø§Ù„Ø³ÙÙ„ÙŠ */
    .chart-section { background: #fff; padding: 22px; border-radius: 28px; border: 1px solid var(--border); margin-bottom: 50px; }
    .chart-viewport { width: 100%; overflow-x: auto; }
    .chart-wrapper { min-width: 800px; height: 300px; }

    /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
    .modal-content { background: white; width: 92%; max-width: 400px; padding: 30px; border-radius: 32px; }
    input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; }
</style>
</head>
<body>

<header><h1>Operations Hub</h1></header>
<div id="syncStatus">ğŸ”„ Loading...</div>

<div class="btn-group">
    <button class="btn btn-danger" onclick="fullReset()">Clear Data</button>
    <button class="btn" onclick="resetConfig()">Setup Cloud</button>
    <button class="btn btn-dark" onclick="openAddDataModal()">+ Record</button>
</div>

<div class="date-nav">
    <button class="btn" style="border:none; font-size:1.5rem" onclick="changeMonth(-1)">â€¹</button>
    <div class="month-label" id="currentMonthDisplay">...</div>
    <button class="btn" style="border:none; font-size:1.5rem" onclick="changeMonth(1)">â€º</button>
</div>

<div class="card-grid" id="dashboard"></div>

<div id="detailSection" class="detail-section">
    <div class="table-header">
        <span id="selectedTypeName">DETAILS</span>
        <button onclick="closeDetails()" style="border:none; background:none; font-weight:900; color:var(--canc); cursor:pointer;">CLOSE Ã—</button>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Succ.</th>
                    <th>Pend.</th>
                    <th>Canc.</th>
                    <th>Total</th>
                    <th>Rate %</th>
                </tr>
            </thead>
            <tbody id="detailTableBody"></tbody>
        </table>
    </div>
</div>

<div class="chart-section">
    <div class="chart-viewport"><div class="chart-wrapper"><canvas id="main_chart"></canvas></div></div>
</div>

<div id="addDataModal" class="modal">
    <div class="modal-content">
        <h3>Daily Entry</h3>
        <input type="date" id="modalDate">
        <div id="modalInputs"></div>
        <button class="btn btn-dark" style="width:100%; margin-top:20px;" id="saveBtn">Save & Sync</button>
        <button class="btn" style="width:100%; margin-top:10px; border:none;" onclick="closeAddDataModal()">Cancel</button>
    </div>
</div>

<script>
let config = JSON.parse(localStorage.getItem('gh_config')) || null;
const types = ["Delivery", "PickUp", "SameDay", "Khazenly"];
const typeColors = { Delivery: '#111827', PickUp: '#10b981', SameDay: '#f59e0b', Khazenly: '#ef4444' };
let data = JSON.parse(localStorage.getItem("shippingData")) || {};
types.forEach(t => { if(!data[t]) data[t] = []; });
let viewDate = new Date();
let activeType = null;

async function init() {
    if (!config) {
        const token = prompt("GitHub Token:");
        const user = prompt("Username:");
        const repo = prompt("Repo Name:");
        if (token) { config = { token, user, repo }; localStorage.setItem('gh_config', JSON.stringify(config)); location.reload(); }
    } else { await fetchFromGitHub(); }
}

async function fetchFromGitHub() {
    const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/data.json`;
    try {
        const res = await fetch(url, { headers: { 'Authorization': `token ${config.token}` } });
        if (res.ok) {
            const j = await res.json();
            data = JSON.parse(decodeURIComponent(escape(atob(j.content))));
            localStorage.setItem("shippingData", JSON.stringify(data));
            document.getElementById('syncStatus').innerText = "âœ… Cloud Synced";
        }
    } catch (e) { document.getElementById('syncStatus').innerText = "âš ï¸ Offline"; }
    renderAll();
}

async function pushToGitHub() {
    if(!config) return;
    document.getElementById('syncStatus').innerText = "â³ Syncing...";
    const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/data.json`;
    try {
        const res = await fetch(url, { headers: { 'Authorization': `token ${config.token}` } });
        let sha = (res.ok) ? (await res.json()).sha : "";
        await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${config.token}` },
            body: JSON.stringify({ message: "update", content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))), sha: sha })
        });
        document.getElementById('syncStatus').innerText = "âœ… Saved";
    } catch (e) { document.getElementById('syncStatus').innerText = "âŒ Error"; }
}

function renderAll() {
    const year = viewDate.getFullYear();
    const month = viewDate.getMonth();
    document.getElementById("currentMonthDisplay").innerText = viewDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
    
    document.getElementById("dashboard").innerHTML = types.map(t => {
        const sum = data[t].filter(d => { 
            let dt = new Date(d.date); return dt.getFullYear() === year && dt.getMonth() === month; 
        }).reduce((s, d) => s + (d.delivered || 0), 0);
        return `<div class="item-card ${activeType === t ? 'active-card' : ''}" onclick="showDetails('${t}')" style="border-left: 6px solid ${typeColors[t]}">
            <span style="font-size:0.7rem; font-weight:900; color:var(--subtle); text-transform:uppercase;">${t}</span>
            <span class="delivered-value" style="color:${typeColors[t]}">${sum}</span>
        </div>`;
    }).join('');

    renderChart(year, month);
    if(activeType) showDetails(activeType);
}

function showDetails(type) {
    activeType = type;
    const section = document.getElementById("detailSection");
    const tbody = document.getElementById("detailTableBody");
    const title = document.getElementById("selectedTypeName");

    section.style.display = "block";
    title.innerText = `${type} - Daily Breakdown`;
    title.style.color = typeColors[type];

    const year = viewDate.getFullYear();
    const month = viewDate.getMonth();
    const filtered = data[type].filter(d => { 
        let dt = new Date(d.date); return dt.getFullYear() === year && dt.getMonth() === month; 
    }).sort((a,b) => new Date(b.date) - new Date(a.date));

    tbody.innerHTML = filtered.map(r => {
        const total = (r.delivered || 0) + (r.pending || 0) + (r.cancelled || 0);
        const rate = total > 0 ? ((r.delivered / total) * 100).toFixed(1) : "0.0";
        return `<tr>
            <td>${r.date}</td>
            <td style="color:var(--deliv)">${r.delivered}</td>
            <td style="color:var(--pend)">${r.pending}</td>
            <td style="color:var(--canc)">${r.cancelled}</td>
            <td style="background:#f9fafb">${total}</td>
            <td><span style="padding:2px 6px; background:#ecfdf5; color:var(--deliv); border-radius:6px;">${rate}%</span></td>
        </tr>`;
    }).join('');
    
    document.querySelectorAll('.item-card').forEach((c,i) => {
        c.classList.toggle('active-card', types[i] === type);
    });
}

function closeDetails() {
    activeType = null;
    document.getElementById("detailSection").style.display = "none";
    renderAll();
}

function renderChart(year, month) {
    const ctx = document.getElementById('main_chart').getContext('2d');
    let days = new Date(year, month + 1, 0).getDate();
    let labels = Array.from({length: days}, (_, i) => i + 1);
    let datasets = types.map(t => ({
        label: t,
        data: labels.map(day => {
            let dStr = `${year}-${String(month+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            let e = data[t].find(d => d.date === dStr);
            return e ? e.delivered : 0;
        }),
        backgroundColor: typeColors[t],
        borderRadius: 5
    }));
    if(window.ch) window.ch.destroy();
    window.ch = new Chart(ctx, { type: 'bar', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false } });
}

function openAddDataModal() {
    document.getElementById("addDataModal").style.display = "flex";
    document.getElementById("modalDate").value = new Date().toISOString().split('T')[0];
    document.getElementById("modalInputs").innerHTML = types.map(t => `
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px; margin-top:10px; align-items:center;">
            <b>${t.charAt(0)}</b>
            <input type="number" id="d_${t}" placeholder="S">
            <input type="number" id="p_${t}" placeholder="P">
            <input type="number" id="c_${t}" placeholder="C">
        </div>`).join('');

    document.getElementById("saveBtn").onclick = async () => {
        const date = document.getElementById("modalDate").value;
        types.forEach(t => {
            const row = { date, delivered: parseInt(document.getElementById(`d_${t}`).value)||0, pending: parseInt(document.getElementById(`p_${t}`).value)||0, cancelled: parseInt(document.getElementById(`c_${t}`).value)||0 };
            let idx = data[t].findIndex(d => d.date === date);
            if(idx >= 0) data[t][idx] = row; else data[t].push(row);
        });
        localStorage.setItem("shippingData", JSON.stringify(data));
        closeAddDataModal(); renderAll(); await pushToGitHub();
    };
}

async function fullReset() {
    if (prompt("Type 'DELETE' to clear all data:") === "DELETE") {
        types.forEach(t => data[t] = []);
        localStorage.setItem("shippingData", JSON.stringify(data));
        closeDetails();
        renderAll();
        await pushToGitHub();
    }
}

function closeAddDataModal() { document.getElementById("addDataModal").style.display = "none"; }
function resetConfig() { localStorage.removeItem('gh_config'); location.reload(); }
function changeMonth(step) { viewDate.setMonth(viewDate.getMonth() + step); renderAll(); }

init();
</script>
</body>
</html>
