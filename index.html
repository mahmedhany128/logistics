<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Logistics Intelligence Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
    :root {
        --primary: #0f172a; --accent: #6366f1; --success: #10b981; 
        --warning: #f59e0b; --danger: #ef4444; --bg: #f8fafc; --card: #ffffff;
    }
    * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); margin: 0; padding: 20px; color: var(--primary); line-height: 1.6; }

    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    header h1 { font-size: 1.5rem; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
    #syncStatus { font-size: 0.65rem; font-weight: 700; background: #fff; padding: 5px 12px; border-radius: 20px; border: 1px solid #e2e8f0; }

    /* ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ© */
    .action-bar { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; }
    .btn { padding: 12px 18px; border: 1px solid #e2e8f0; background: var(--card); border-radius: 14px; font-size: 0.8rem; font-weight: 700; cursor: pointer; white-space: nowrap; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
    .btn:hover { background: #f1f5f9; }
    .btn-dark { background: var(--primary); color: #fff; border: none; box-shadow: 0 4px 12px rgba(15,23,42,0.2); }
    .btn-danger { color: var(--danger); background: #fff5f5; border-color: #feb2b2; }

    /* ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ®ÿßŸÑÿ™ÿßÿ±ŸäÿÆ */
    .date-control { background: var(--card); padding: 10px 20px; border-radius: 18px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border: 1px solid #e2e8f0; }
    .month-label { font-weight: 800; font-size: 1rem; color: var(--primary); }

    /* ÿ¥ÿ®ŸÉÿ© ÿßŸÑŸÉÿ±Ÿàÿ™ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑŸäÿ© */
    .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .item-card { background: var(--card); padding: 20px; border-radius: 24px; border: 1px solid #e2e8f0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; position: relative; overflow: hidden; }
    .item-card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px -10px rgba(0,0,0,0.1); }
    .active-card { border: 2px solid var(--accent); background: #f5f7ff; }
    .card-label { font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 8px; display: block; }
    .card-value { font-size: 1.8rem; font-weight: 800; display: block; color: var(--primary); }

    /* ÿßŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸä */
    .analysis-section { display: none; background: var(--card); border-radius: 28px; border: 1px solid #e2e8f0; margin-bottom: 25px; box-shadow: 0 10px 30px -15px rgba(0,0,0,0.05); }
    .table-header { padding: 20px 25px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    .table-header h3 { margin: 0; font-size: 1rem; font-weight: 800; }
    .table-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 550px; }
    th { padding: 15px 25px; text-align: left; font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
    td { padding: 15px 25px; font-size: 0.85rem; font-weight: 600; border-bottom: 1px solid #f8fafc; }
    .date-cell { color: #64748b; font-size: 0.8rem; }
    .badge { padding: 4px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; }

    /* ŸÇÿ≥ŸÖ ÿßŸÑÿ¥ÿßÿ±ÿ™ */
    .chart-card { background: var(--card); padding: 25px; border-radius: 28px; border: 1px solid #e2e8f0; margin-bottom: 40px; }
    .chart-container { height: 350px; position: relative; }

    /* ÿßŸÑŸÖŸàÿØÿßŸÑ */
    .modal { display: none; position: fixed; inset: 0; background: rgba(15,23,42,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal-content { background: white; width: 90%; max-width: 450px; padding: 35px; border-radius: 32px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
    input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #e2e8f0; border-radius: 16px; font-weight: 600; }
</style>
</head>
<body>

<header>
    <h1>Intelligence Hub</h1>
    <div id="syncStatus">‚òÅÔ∏è INITIALIZING</div>
</header>

<div class="action-bar">
    <button class="btn btn-dark" onclick="openAddDataModal()"><span>+</span> New Entry</button>
    <button class="btn" onclick="exportExcel()">Export Reports</button>
    <button class="btn" onclick="resetConfig()">Cloud Settings</button>
    <button class="btn btn-danger" onclick="fullReset()">Wipe Data</button>
</div>

<div class="date-control">
    <button class="btn" style="padding:8px" onclick="changeMonth(-1)">‚Üê</button>
    <div class="month-label" id="currentMonthDisplay">...</div>
    <button class="btn" style="padding:8px" onclick="changeMonth(1)">‚Üí</button>
</div>

<div class="card-grid" id="dashboard"></div>

<div id="analysisBox" class="analysis-section">
    <div class="table-header">
        <h3 id="analysisTitle">ANALYTICS</h3>
        <button class="btn" style="padding:5px 12px; border-radius:10px" onclick="closeDetails()">Close</button>
    </div>
    <div class="table-scroll">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Succ. (S)</th>
                    <th>Pend. (P)</th>
                    <th>Canc. (C)</th>
                    <th>Volume</th>
                    <th>Efficiency</th>
                </tr>
            </thead>
            <tbody id="analysisBody"></tbody>
        </table>
    </div>
</div>

<div class="chart-card">
    <div class="chart-container">
        <canvas id="performanceChart"></canvas>
    </div>
</div>

<div id="addDataModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-top:0; font-weight:800">Add Logistics Log</h2>
        <input type="date" id="modalDate">
        <div id="modalInputs"></div>
        <button class="btn btn-dark" style="width:100%; margin-top:20px; justify-content:center" id="saveBtn">Save Record</button>
        <button class="btn" style="width:100%; margin-top:10px; border:none; justify-content:center" onclick="closeAddDataModal()">Discard</button>
    </div>
</div>

<script>
let config = JSON.parse(localStorage.getItem('bi_config')) || null;
const channels = ["Delivery", "PickUp", "SameDay", "Khazenly"];
const channelColors = { Delivery: '#6366f1', PickUp: '#10b981', SameDay: '#f59e0b', Khazenly: '#f43f5e' };
let masterData = JSON.parse(localStorage.getItem("bi_data")) || {};
channels.forEach(c => { if(!masterData[c]) masterData[c] = []; });
let viewDate = new Date();
let selectedChannel = null;

// Ÿàÿ∏ŸäŸÅÿ© ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©: 1 Feb 2025
function formatProDate(dateStr) {
    const d = new Date(dateStr);
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
}

async function init() {
    if (!config) {
        const token = prompt("GitHub Token:");
        const user = prompt("GitHub Username:");
        const repo = prompt("Repo Name:");
        if (token && user && repo) {
            config = { token, user, repo };
            localStorage.setItem('bi_config', JSON.stringify(config));
            location.reload();
        }
    } else { await syncWithCloud(); }
}

async function syncWithCloud() {
    const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/data.json`;
    try {
        const res = await fetch(url, { headers: { 'Authorization': `token ${config.token}` } });
        if (res.ok) {
            const j = await res.json();
            masterData = JSON.parse(decodeURIComponent(escape(atob(j.content))));
            localStorage.setItem("bi_data", JSON.stringify(masterData));
            document.getElementById('syncStatus').innerText = "üü¢ CLOUD SYNCED";
        }
    } catch (e) { document.getElementById('syncStatus').innerText = "üî¥ OFFLINE MODE"; }
    refreshUI();
}

async function pushToCloud() {
    document.getElementById('syncStatus').innerText = "‚è≥ UPLOADING...";
    const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/data.json`;
    try {
        const res = await fetch(url, { headers: { 'Authorization': `token ${config.token}` } });
        let sha = (res.ok) ? (await res.json()).sha : "";
        await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${config.token}` },
            body: JSON.stringify({ message: "BI System Update", content: btoa(unescape(encodeURIComponent(JSON.stringify(masterData, null, 2)))), sha: sha })
        });
        document.getElementById('syncStatus').innerText = "üü¢ DATA SECURED";
    } catch (e) { alert("Cloud Push Failed"); }
}

function refreshUI() {
    const yr = viewDate.getFullYear();
    const mt = viewDate.getMonth();
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    document.getElementById("currentMonthDisplay").innerText = `${monthNames[mt]} ${yr}`;
    
    // ÿ®ŸÜÿßÿ° ÿßŸÑŸÉÿ±Ÿàÿ™
    document.getElementById("dashboard").innerHTML = channels.map(c => {
        const totalSucc = masterData[c].filter(d => {
            const dt = new Date(d.date); return dt.getFullYear() === yr && dt.getMonth() === mt;
        }).reduce((sum, d) => sum + (d.s || 0), 0);
        
        return `
            <div class="item-card ${selectedChannel === c ? 'active-card' : ''}" onclick="openAnalysis('${c}')">
                <span class="card-label">${c}</span>
                <span class="card-value">${totalSucc.toLocaleString()}</span>
                <div style="height:4px; background:${channelColors[c]}; width:40%; border-radius:10px; margin-top:10px;"></div>
            </div>`;
    }).join('');

    renderMainChart(yr, mt);
    if(selectedChannel) openAnalysis(selectedChannel);
}

function openAnalysis(channel) {
    selectedChannel = channel;
    refreshUI(); // ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÄ active class
    const box = document.getElementById("analysisBox");
    const body = document.getElementById("analysisBody");
    const title = document.getElementById("analysisTitle");
    
    box.style.display = "block";
    title.innerText = `${channel.toUpperCase()} EFFICIENCY ANALYSIS`;

    const yr = viewDate.getFullYear();
    const mt = viewDate.getMonth();
    const history = masterData[channel].filter(d => {
        const dt = new Date(d.date); return dt.getFullYear() === yr && dt.getMonth() === mt;
    }).sort((a,b) => new Date(b.date) - new Date(a.date));

    body.innerHTML = history.map(r => {
        const total = (r.s||0) + (r.p||0) + (r.c||0);
        const efficiency = total > 0 ? ((r.s/total)*100).toFixed(1) : 0;
        const effColor = efficiency > 85 ? '#10b981' : (efficiency > 60 ? '#f59e0b' : '#ef4444');
        
        return `
            <tr>
                <td class="date-cell">${formatProDate(r.date)}</td>
                <td style="color:var(--success)">${r.s}</td>
                <td>${r.p}</td>
                <td style="color:var(--danger)">${r.c}</td>
                <td style="background:#f8fafc; font-weight:800">${total}</td>
                <td><span class="badge" style="background:${effColor}15; color:${effColor}">${efficiency}%</span></td>
            </tr>`;
    }).join('');
    box.scrollIntoView({behavior: 'smooth', block: 'center'});
}

function renderMainChart(yr, mt) {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const days = new Date(yr, mt + 1, 0).getDate();
    const labels = Array.from({length: days}, (_, i) => i + 1);
    
    const datasets = channels.map(c => ({
        label: c,
        data: labels.map(day => {
            const dateStr = `${yr}-${String(mt+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const found = masterData[c].find(d => d.date === dateStr);
            return found ? found.s : 0;
        }),
        borderColor: channelColors[c],
        backgroundColor: channelColors[c] + '20',
        fill: true,
        tension: 0.4,
        pointRadius: 2
    }));

    if(window.mainChart) window.mainChart.destroy();
    window.mainChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top', labels: { usePointStyle: true, font: { weight: 'bold', size: 10 } } } },
            scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
        }
    });
}

function openAddDataModal() {
    document.getElementById("addDataModal").style.display = "flex";
    document.getElementById("modalDate").value = new Date().toISOString().split('T')[0];
    document.getElementById("modalInputs").innerHTML = channels.map(c => `
        <div style="margin-bottom:15px; padding:10px; background:#f8fafc; border-radius:15px;">
            <div style="font-weight:800; font-size:0.75rem; color:${channelColors[c]}; margin-bottom:8px;">${c.toUpperCase()}</div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                <input type="number" id="s_${c}" placeholder="Succ." style="margin:0; padding:10px; font-size:0.8rem">
                <input type="number" id="p_${c}" placeholder="Pend." style="margin:0; padding:10px; font-size:0.8rem">
                <input type="number" id="c_${c}" placeholder="Canc." style="margin:0; padding:10px; font-size:0.8rem">
            </div>
        </div>`).join('');

    document.getElementById("saveBtn").onclick = async () => {
        const date = document.getElementById("modalDate").value;
        channels.forEach(c => {
            const entry = { 
                date, 
                s: parseInt(document.getElementById(`s_${c}`).value)||0, 
                p: parseInt(document.getElementById(`p_${c}`).value)||0, 
                c: parseInt(document.getElementById(`c_${c}`).value)||0 
            };
            const idx = masterData[c].findIndex(d => d.date === date);
            if(idx >= 0) masterData[c][idx] = entry; else masterData[c].push(entry);
        });
        localStorage.setItem("bi_data", JSON.stringify(masterData));
        closeAddDataModal(); refreshUI(); await pushToCloud();
    };
}

function closeAddDataModal() { document.getElementById("addDataModal").style.display = "none"; }
function closeDetails() { selectedChannel = null; document.getElementById("analysisBox").style.display = "none"; refreshUI(); }
function changeMonth(step) { viewDate.setMonth(viewDate.getMonth() + step); refreshUI(); }
function resetConfig() { localStorage.removeItem('bi_config'); location.reload(); }
function exportExcel() { 
    const wb = XLSX.utils.book_new();
    channels.forEach(c => XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(masterData[c]), c));
    XLSX.writeFile(wb, `Logistics_Report_${viewDate.getMonth()+1}_${viewDate.getFullYear()}.xlsx`);
}
async function fullReset() { if(confirm("This will PERMANENTLY delete all data. Proceed?")) { if(prompt("Type DELETE to confirm") === "DELETE") { channels.forEach(c => masterData[c] = []); localStorage.setItem("bi_data", JSON.stringify(masterData)); refreshUI(); await pushToCloud(); } } }

init();
</script>
</body>
</html>
