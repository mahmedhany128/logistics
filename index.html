<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Logistics Pro - Cloud & Tables</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111827">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1554/1554561.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

<style>
    :root {
        --primary: #111827; --subtle: #9ca3af; --border: #f3f4f6;
        --deliv: #10b981; --pend: #f59e0b; --canc: #ef4444; --bg: #f9fafb;
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); margin: 0; padding: 15px; color: var(--primary); }

    header h1 { font-size: 1.4rem; font-weight: 900; text-align: center; margin-bottom: 20px; }
    
    .sync-indicator { text-align: center; font-size: 0.65rem; font-weight: 800; margin-bottom: 15px; padding: 5px; border-radius: 10px; }

    /* Tables Style */
    .table-section { margin-top: 30px; background: #fff; border-radius: 28px; border: 1px solid var(--border); overflow: hidden; }
    .table-header { padding: 20px; border-bottom: 1px solid var(--border); font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
    table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
    th { background: #f9fafb; padding: 12px; text-align: left; color: var(--subtle); text-transform: uppercase; font-size: 0.6rem; }
    td { padding: 12px; border-bottom: 1px solid #fefefe; font-weight: 600; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }

    /* Original Styles */
    .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 25px; }
    .btn { padding: 14px; border: 1px solid #e5e7eb; background: #fff; border-radius: 16px; font-size: 0.8rem; font-weight: 800; cursor: pointer; }
    .btn-dark { background: var(--primary); color: #fff; border: none; }
    
    .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .item-card { padding: 20px; border-radius: 26px; background: #fff; border: 1px solid var(--border); border-left: 6px solid #ccc; }
    .delivered-value { font-size: 2.1rem; font-weight: 900; display: block; }

    .chart-section { margin-top: 30px; background: #fff; padding: 22px; border-radius: 28px; border: 1px solid var(--border); }
    .chart-viewport { width: 100%; overflow-x: auto; }
    .chart-wrapper { min-width: 800px; height: 300px; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
    .modal-content { background: white; width: 92%; max-width: 400px; padding: 30px; border-radius: 32px; }
    input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; }
</style>
</head>
<body>

<header><h1>Operations Hub</h1></header>
<div id="syncIndicator" class="sync-indicator">âšª Initializing...</div>

<div class="btn-group">
    <button class="btn" onclick="verifiedClearAll()">Reset</button>
    <button class="btn" onclick="exportExcel()">Export</button>
    <button class="btn btn-dark" onclick="openAddDataModal()">+ Record</button>
</div>

<div class="card-grid" id="dashboard"></div>

<div class="chart-section">
    <div class="chart-viewport"><div class="chart-wrapper"><canvas id="main_chart"></canvas></div></div>
</div>

<div class="table-section">
    <div class="table-header">
        <span>Recent Activity</span>
        <button class="btn" style="padding:5px 10px; font-size:0.6rem;" onclick="fetchFromGitHub()">ðŸ”„ Refresh</button>
    </div>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Channel</th>
                    <th>Succ.</th>
                    <th>Pend.</th>
                    <th>Canc.</th>
                </tr>
            </thead>
            <tbody id="historyTableBody"></tbody>
        </table>
    </div>
</div>

<div id="addDataModal" class="modal">
    <div class="modal-content">
        <h3>Daily Log</h3>
        <input type="date" id="modalDate">
        <div id="modalInputs"></div>
        <button class="btn btn-dark" style="width:100%; margin-top:20px;" id="saveBtn">Sync to Cloud</button>
        <button class="btn" style="width:100%; margin-top:10px;" onclick="closeAddDataModal()">Cancel</button>
    </div>
</div>

<script>
let config = JSON.parse(localStorage.getItem('gh_config')) || null;
const types = ["Delivery", "PickUp", "SameDay", "Khazenly"];
const typeColors = { Delivery: '#111827', PickUp: '#10b981', SameDay: '#f59e0b', Khazenly: '#ef4444' };
let data = JSON.parse(localStorage.getItem("shippingData")) || {};
types.forEach(t => { if(!data[t]) data[t] = []; });

async function init() {
    if (!config) {
        const token = prompt("GitHub Token:");
        const user = prompt("Username:");
        const repo = prompt("Repo Name:");
        if (token) {
            config = { token, user, repo };
            localStorage.setItem('gh_config', JSON.stringify(config));
            location.reload();
        }
    } else {
        await fetchFromGitHub();
    }
}

async function fetchFromGitHub() {
    const status = document.getElementById('syncIndicator');
    status.innerText = "â³ Fetching cloud data...";
    try {
        const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/data.json`;
        const res = await fetch(url, { headers: { 'Authorization': `token ${config.token}` } });
        if (res.ok) {
            const j = await res.json();
            data = JSON.parse(decodeURIComponent(escape(atob(j.content))));
            localStorage.setItem("shippingData", JSON.stringify(data));
            status.innerText = "âœ… Cloud Synced";
            status.style.color = "green";
        }
    } catch (e) { status.innerText = "âš ï¸ Offline Mode"; }
    renderAll();
}

async function pushToGitHub() {
    const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/data.json`;
    try {
        const res = await fetch(url, { headers: { 'Authorization': `token ${config.token}` } });
        let sha = (res.ok) ? (await res.json()).sha : "";
        await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${config.token}` },
            body: JSON.stringify({
                message: "update",
                content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                sha: sha
            })
        });
    } catch (e) { alert("Cloud save failed"); }
}

function renderAll() {
    renderDashboard();
    renderTable();
    renderChart();
}

function renderDashboard() {
    const container = document.getElementById("dashboard");
    container.innerHTML = types.map(t => {
        const sum = data[t].reduce((s, d) => s + (d.delivered || 0), 0);
        return `
            <div class="item-card" style="border-left-color: ${typeColors[t]}">
                <span style="font-size:0.7rem; font-weight:900; color:var(--subtle)">${t}</span>
                <span class="delivered-value" style="color:${typeColors[t]}">${sum}</span>
            </div>`;
    }).join('');
}

function renderTable() {
    const tbody = document.getElementById("historyTableBody");
    let allRows = [];
    types.forEach(t => {
        data[t].forEach(entry => allRows.push({ ...entry, type: t }));
    });
    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø­Ø¯Ø«
    allRows.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    tbody.innerHTML = allRows.slice(0, 15).map(r => `
        <tr>
            <td>${r.date}</td>
            <td><span class="status-dot" style="background:${typeColors[r.type]}"></span>${r.type}</td>
            <td style="color:var(--deliv)">${r.delivered}</td>
            <td style="color:var(--pend)">${r.pending}</td>
            <td style="color:var(--canc)">${r.cancelled}</td>
        </tr>
    `).join('');
}

function renderChart() {
    const ctx = document.getElementById('main_chart').getContext('2d');
    const last7Days = [...new Set(Object.values(data).flat().map(d => d.date))].sort().slice(-7);
    
    const datasets = types.map(t => ({
        label: t,
        data: last7Days.map(date => {
            const entry = data[t].find(d => d.date === date);
            return entry ? entry.delivered : 0;
        }),
        backgroundColor: typeColors[t]
    }));

    if(window.chartObj) window.chartObj.destroy();
    window.chartObj = new Chart(ctx, { type: 'bar', data: { labels: last7Days, datasets }, options: { responsive: true, maintainAspectRatio: false } });
}

function openAddDataModal() {
    document.getElementById("addDataModal").style.display = "flex";
    document.getElementById("modalDate").value = new Date().toISOString().split('T')[0];
    document.getElementById("modalInputs").innerHTML = types.map(t => `
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px; margin-top:10px;">
            <b style="font-size:0.6rem;">${t}</b>
            <input type="number" id="d_${t}" placeholder="S">
            <input type="number" id="p_${t}" placeholder="P">
            <input type="number" id="c_${t}" placeholder="C">
        </div>`).join('');

    document.getElementById("saveBtn").onclick = async () => {
        const date = document.getElementById("modalDate").value;
        types.forEach(t => {
            const row = { date, delivered: parseInt(document.getElementById(`d_${t}`).value)||0, pending: parseInt(document.getElementById(`p_${t}`).value)||0, cancelled: parseInt(document.getElementById(`c_${t}`).value)||0 };
            const idx = data[t].findIndex(d => d.date === date);
            if(idx >= 0) data[t][idx] = row; else data[t].push(row);
        });
        localStorage.setItem("shippingData", JSON.stringify(data));
        closeAddDataModal();
        renderAll();
        await pushToGitHub();
    };
}

function closeAddDataModal() { document.getElementById("addDataModal").style.display = "none"; }
function verifiedClearAll() { if(confirm("Delete all?")) { localStorage.clear(); location.reload(); } }
function exportExcel() { 
    const wb = XLSX.utils.book_new();
    types.forEach(t => XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data[t]), t));
    XLSX.writeFile(wb, "Logistics_Report.xlsx");
}

init();
</script>
</body>
</html>
